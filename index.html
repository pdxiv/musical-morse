<!DOCTYPE html>
<html>

<head>
    <title>Morse Code Player</title>
    <script>
        let audioData;


        function generateAudioData() {
            try {
                const tempo = 120.0;
                const inputText = "stop radioactivity";
                const sampleRate = 44100;
                const morseCode = textToMorse(inputText); // Make sure this function is defined
                audioData = createMorseCodeAudioData(morseCode, sampleRate, tempo); // Make sure this function is defined
            } catch (error) {
                console.error("Error:", error.message);
                audioData = null;
            }
        }

        function playAudioData(audioData, sampleRate) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const audioBuffer = audioContext.createBuffer(1, audioData.length, sampleRate);

            // Fill the AudioBuffer with the audio data
            const bufferChannel = audioBuffer.getChannelData(0);
            for (let i = 0; i < audioData.length; i++) {
                bufferChannel[i] = audioData[i] / 32767; // Convert from 16-bit to floating point
            }

            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            source.start();
        }

        function generateWAVBlob(audioData, sampleRate) {
            const buffer = new ArrayBuffer(44 + audioData.length * 2);
            const view = new DataView(buffer);

            // Writing the WAV file header
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + audioData.length * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, audioData.length * 2, true);

            // Writing the audio data
            for (let i = 0; i < audioData.length; i++) {
                view.setInt16(44 + i * 2, audioData[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function download(blob, filename) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        }

        document.addEventListener('DOMContentLoaded', function () {
            const playButton = document.getElementById('playButton');
            const downloadButton = document.getElementById('downloadButton');

            playButton.addEventListener('click', function () {
                generateAudioData();
                if (audioData) {
                    playAudioData(audioData, 44100); // Make sure this function is defined
                }
            });

            downloadButton.addEventListener('click', function () {
                if (!audioData) {
                    generateAudioData();
                }
                if (audioData) {
                    const wavBlob = generateWAVBlob(audioData, 44100); // Make sure this function is defined
                    download(wavBlob, 'morse_code_audio.wav'); // Make sure this function is defined
                }
            });
        });

    </script>
</head>

<body>
    <button id="playButton">Play Morse Code</button>
    <button id="downloadButton">Download as WAV</button>

    <script src="morse-code-player.js"></script>
</body>

</html>